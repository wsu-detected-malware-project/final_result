using System;
using System.IO;
using System.Linq;
using System.Reflection.Metadata;
using System.Text;
using System.Windows.Forms;

public static class MalwareCleaner
{
    public static void DeleteFiles(string resultCsvPath, double threshold = 0.7)
    {
        if (!File.Exists(resultCsvPath))
        {
            MessageBox.Show("result.csv 파일을 찾을 수 없습니다.");
            return;
        }

        var lines = File.ReadAllLines(resultCsvPath, Encoding.UTF8);
        if (lines.Length <= 1)
        {
            MessageBox.Show("result.csv에 검사 결과가 없습니다.");
            return;
        }

        string windowsPath = Environment.GetFolderPath(Environment.SpecialFolder.Windows); //윈도우 파일 삭제 방지
        string logFilePath = "deleted_files.txt";
        int deletedCount = 0;

        using (var logWriter = new StreamWriter(logFilePath, false, Encoding.UTF8))
        {
            foreach (var line in lines.Skip(1))
            {
                var parts = line.Split(',');
                if (parts.Length < 4)
                    continue;

                if (double.TryParse(parts[2], out double score) && score >= threshold)
                {
                    string path = Path.GetFullPath(parts[3].Trim('"').Trim()).Replace('/', '\\');
                    if (File.Exists(path))
                    {
                        string normalizedPath = Path.GetFullPath(path).Replace('\\', '/'    ); 
                        string normalizedWindowsPath = windowsPath.Replace('\\', '/'); 

                        if (normalizedPath.StartsWith(normalizedWindowsPath + "/", StringComparison.OrdinalIgnoreCase))
                        {
                            continue;
                        }
                        try
                        {

                            var fileInfo = new FileInfo(path);
                            fileInfo.Attributes = FileAttributes.Normal;

                            File.Delete(path);


                            logWriter.WriteLine(path);
                            deletedCount++;
                        }
                        catch { }
                       
                    }
                }
            }
        }
        MessageBox.Show($"삭제 완료: {deletedCount}개 파일 삭제됨", "악성 파일 제거");
    }
}
